@page "/users/{UserId:int}/profile"

@inject NavigationManager _navigationManager
@inject IUserApiService _userApiService
@inject IAccessService _accessService

<h3>User Details</h3>

@if (isLoading)
{
    <p><em>Loading user details...</em></p>
}
else if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger">@errorMessage</div>
}
else if (userDetail != null)
{
    <div class="card shadow p-4">
        <div class="mb-3">
            <strong>ID:</strong> @userDetail.UserId
        </div>
        <div class="mb-3">
            <strong>Name:</strong> @userDetail.Name
        </div>
        <div class="mb-3">
            <strong>Email:</strong> @userDetail.Email
        </div>
        <div class="mb-3">
            <strong>Created Date:</strong> @userDetail.CreatedDate.ToShortDateString()
        </div>
        <div class="mt-3">
            <button class="btn btn-secondary me-2" @onclick="GoBack">Back to List</button>
            @if (isOrganizer)
            {
                <button class="btn btn-primary" @onclick="EditUser">Edit User</button>
            }
        </div>
    </div>
}
else
{
     <p><em>User not found.</em></p>
}


@code {
    [Parameter]
    public int UserId { get; set; }

    private UserResponse? userDetail;
    private string? errorMessage;
    private bool isLoading = true;
    private bool isLoggedIn = false;
    private bool isOrganizer = false;

    protected override async Task OnInitializedAsync()
    {
        isLoading = true;
        try
        {
            // Check access rights
            isLoggedIn = await _accessService.IsUserLoggedInAsync();
            isOrganizer = await _accessService.IsOrganizerAsync();

            // Allow only organizer to view the page - redirect elsewhere otherwise
            RoleBasedRedirector.CheckOrganizerAccess(isLoggedIn, isOrganizer, _navigationManager);


            var result = await _userApiService.GetByIdAsync(UserId);
            if (result.IsSuccess && result.Data != null)
            {
                userDetail = result.Data;
            }
            else
            {
                errorMessage = result.ErrorMessage ?? "Failed to load user details.";
            }
        }
        catch (Exception ex)
        {
            // Handle potential exceptions during API call or access checks
            errorMessage = $"An error occurred: {ex.Message}";
            // Optionally redirect on critical errors
             _navigationManager.NavigateTo("/auth/login");
        }
        finally
        {
            isLoading = false;
        }
    }

    private void GoBack()
    {
        _navigationManager.NavigateTo("/users");
    }

    private void EditUser()
    {
        _navigationManager.NavigateTo($"/users/{UserId}/edit");
    }
}
